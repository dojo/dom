(function (factory) {
    if (typeof module === 'object' && typeof module.exports === 'object') {
        var v = factory(require, exports); if (v !== undefined) module.exports = v;
    }
    else if (typeof define === 'function' && define.amd) {
        define(["require", "exports", './queue'], factory);
    }
})(function (require, exports) {
    var queue_1 = require('./queue');
    function getQueueHandle(item) {
        return {
            destroy: function () {
                this.destroy = function () { };
                item.isActive = false;
                item.callback = null;
            }
        };
    }
    var Scheduler = (function () {
        function Scheduler(kwArgs) {
            this.deferWhileProcessing = (kwArgs && 'deferWhileProcessing' in kwArgs) ? kwArgs.deferWhileProcessing : true;
            this.queueFunction = (kwArgs && kwArgs.queueFunction) ? kwArgs.queueFunction : queue_1.queueTask;
            this._boundDispatch = this._dispatch.bind(this);
            this._isProcessing = false;
            this._queue = [];
        }
        Scheduler.prototype._defer = function (callback) {
            var item = {
                isActive: true,
                callback: callback
            };
            if (!this._deferred) {
                this._deferred = [];
            }
            this._deferred.push(item);
            return getQueueHandle(item);
        };
        Scheduler.prototype._dispatch = function () {
            this._isProcessing = true;
            this._task.destroy();
            this._task = null;
            var queue = this._queue;
            var item;
            while (item = queue.shift()) {
                if (item.isActive) {
                    item.callback();
                }
            }
            this._isProcessing = false;
            var deferred = this._deferred;
            if (deferred && deferred.length) {
                this._deferred = null;
                var item_1;
                while (item_1 = deferred.shift()) {
                    this._schedule(item_1);
                }
            }
        };
        Scheduler.prototype._schedule = function (item) {
            if (!this._task) {
                this._task = this.queueFunction(this._boundDispatch);
            }
            this._queue.push(item);
        };
        Scheduler.prototype.schedule = function (callback) {
            if (this._isProcessing && this.deferWhileProcessing) {
                return this._defer(callback);
            }
            var item = {
                isActive: true,
                callback: callback
            };
            this._schedule(item);
            return getQueueHandle(item);
        };
        return Scheduler;
    })();
    Object.defineProperty(exports, "__esModule", { value: true });
    exports.default = Scheduler;
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2NoZWR1bGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1NjaGVkdWxlci50cyJdLCJuYW1lcyI6WyJnZXRRdWV1ZUhhbmRsZSIsIlNjaGVkdWxlciIsIlNjaGVkdWxlci5jb25zdHJ1Y3RvciIsIlNjaGVkdWxlci5fZGVmZXIiLCJTY2hlZHVsZXIuX2Rpc3BhdGNoIiwiU2NoZWR1bGVyLl9zY2hlZHVsZSIsIlNjaGVkdWxlci5zY2hlZHVsZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7SUFDQSxzQkFBcUMsU0FBUyxDQUFDLENBQUE7SUFFL0Msd0JBQXdCLElBQWU7UUFDdENBLE1BQU1BLENBQUNBO1lBQ05BLE9BQU9BLEVBQUVBO2dCQUNSLElBQUksQ0FBQyxPQUFPLEdBQUcsY0FBYSxDQUFDLENBQUM7Z0JBQzlCLElBQUksQ0FBQyxRQUFRLEdBQUcsS0FBSyxDQUFDO2dCQUN0QixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztZQUN0QixDQUFDO1NBQ0RBLENBQUNBO0lBQ0hBLENBQUNBO0lBT0Q7UUFxRUNDLG1CQUFZQSxNQUFlQTtZQUMxQkMsSUFBSUEsQ0FBQ0Esb0JBQW9CQSxHQUFHQSxDQUFDQSxNQUFNQSxJQUFJQSxzQkFBc0JBLElBQUlBLE1BQU1BLENBQUNBLEdBQUdBLE1BQU1BLENBQUNBLG9CQUFvQkEsR0FBR0EsSUFBSUEsQ0FBQ0E7WUFDOUdBLElBQUlBLENBQUNBLGFBQWFBLEdBQUdBLENBQUNBLE1BQU1BLElBQUlBLE1BQU1BLENBQUNBLGFBQWFBLENBQUNBLEdBQUdBLE1BQU1BLENBQUNBLGFBQWFBLEdBQUdBLGlCQUFTQSxDQUFDQTtZQUV6RkEsSUFBSUEsQ0FBQ0EsY0FBY0EsR0FBR0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDaERBLElBQUlBLENBQUNBLGFBQWFBLEdBQUdBLEtBQUtBLENBQUNBO1lBQzNCQSxJQUFJQSxDQUFDQSxNQUFNQSxH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O1lBRXJCQSxNQUFNQSxDQUFDQSxjQUFjQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUM3QkEsQ0FBQ0E7UUFDRkwsZ0JBQUNBO0lBQURBLENBQUNBLEFBNUZELElBNEZDO0lBNUZEOytCQTRGQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSGFuZGxlIH0gZnJvbSAnLi9pbnRlcmZhY2VzJztcbmltcG9ydCB7IFF1ZXVlSXRlbSwgcXVldWVUYXNrIH0gZnJvbSAnLi9xdWV1ZSc7XG5cbmZ1bmN0aW9uIGdldFF1ZXVlSGFuZGxlKGl0ZW06IFF1ZXVlSXRlbSk6IEhhbmRsZSB7XG5cdHJldHVybiB7XG5cdFx0ZGVzdHJveTogZnVuY3Rpb24gKCkge1xuXHRcdFx0dGhpcy5kZXN0cm95ID0gZnVuY3Rpb24gKCkge307XG5cdFx0XHRpdGVtLmlzQWN0aXZlID0gZmFsc2U7XG5cdFx0XHRpdGVtLmNhbGxiYWNrID0gbnVsbDtcblx0XHR9XG5cdH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgS3dBcmdzIHtcblx0ZGVmZXJXaGlsZVByb2Nlc3Npbmc/OiBib29sZWFuO1xuXHRxdWV1ZUZ1bmN0aW9uPzogKGNhbGxiYWNrOiAoLi4uYXJnczogYW55W10pID0+IGFueSkgPT4gSGFuZGxlO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTY2hlZHVsZXIge1xuXHRwcm90ZWN0ZWQgX2JvdW5kRGlzcGF0Y2g6ICgpID0+IHZvaWQ7XG5cdHByb3RlY3RlZCBfZGVmZXJyZWQ6IFF1ZXVlSXRlbVtdO1xuXHRwcm90ZWN0ZWQgX2lzUHJvY2Vzc2luZzogYm9vbGVhbjtcblx0cHJvdGVjdGVkIF9xdWV1ZTogUXVldWVJdGVtW107XG5cdHByb3RlY3RlZCBfdGFzazogSGFuZGxlO1xuXG5cdC8qKlxuXHQgKiBEZXRlcm1pbmVzIHdoZXRoZXIgYW55IGNhbGxiYWNrcyByZWdpc3RlcmVkIGR1cmluZyBzaG91bGQgYmUgYWRkZWQgdG8gdGhlIGN1cnJlbnQgYmF0Y2ggKGBmYWxzZWApXG5cdCAqIG9yIGRlZmVycmVkIHVudGlsIHRoZSBuZXh0IGJhdGNoIChgdHJ1ZWAsIGRlZmF1bHQpLlxuXHQgKi9cblx0ZGVmZXJXaGlsZVByb2Nlc3Npbmc6IGJvb2xlYW47XG5cblx0LyoqXG5cdCAqIEFsbG93cyB1c2VycyB0byBzcGVjaWZ5IHRoZSBmdW5jdGlvbiB0aGF0IHNob3VsZCBiZSB1c2VkIHRvIHNjaGVkdWxlIGNhbGxiYWNrcy5cblx0ICogSWYgbm8gZnVuY3Rpb24gaXMgcHJvdmlkZWQsIHRoZW4gYHF1ZXVlVGFza2Agd2lsbCBiZSB1c2VkLlxuXHQgKi9cblx0cXVldWVGdW5jdGlvbjogKGNhbGxiYWNrOiAoLi4uYXJnczogYW55W10pID0+IGFueSkgPT4gSGFuZGxlO1xuXG5cdHByb3RlY3RlZCBfZGVmZXIoY2FsbGJhY2s6ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCk6IEhhbmRsZSB7XG5cdFx0Y29uc3QgaXRlbTogUXVldWVJdGVtID0ge1xuXHRcdFx0aXNBY3RpdmU6IHRydWUsXG5cdFx0XHRjYWxsYmFjazogY2FsbGJhY2tcblx0XHR9O1xuXG5cdFx0aWYgKCF0aGlzLl9kZWZlcnJlZCkge1xuXHRcdFx0dGhpcy5fZGVmZXJyZWQgPSBbXTtcblx0XHR9XG5cblx0XHR0aGlzLl9kZWZlcnJlZC5wdXNoKGl0ZW0pO1xuXG5cdFx0cmV0dXJuIGdldFF1ZXVlSGFuZGxlKGl0ZW0pO1xuXHR9XG5cblx0cHJvdGVjdGVkIF9kaXNwYXRjaCgpOiB2b2lkIHtcblx0XHR0aGlzLl9pc1Byb2Nlc3NpbmcgPSB0cnVlO1xuXHRcdHRoaXMuX3Rhc2suZGVzdHJveSgpO1xuXHRcdHRoaXMuX3Rhc2sgPSBudWxsO1xuXG5cdFx0Y29uc3QgcXVldWUgPSB0aGlzLl9xdWV1ZTtcblx0XHRsZXQgaXRlbTogUXVldWVJdGVtO1xuXG5cdFx0d2hpbGUgKGl0ZW0gPSBxdWV1ZS5zaGlmdCgpKSB7XG5cdFx0XHRpZiAoaXRlbS5pc0FjdGl2ZSkge1xuXHRcdFx0XHRpdGVtLmNhbGxiYWNrKCk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0dGhpcy5faXNQcm9jZXNzaW5nID0gZmFsc2U7XG5cblx0XHRsZXQgZGVmZXJyZWQ6IFF1ZXVlSXRlbVtdID0gdGhpcy5fZGVmZXJyZWQ7XG5cdFx0aWYgKGRlZmVycmVkICYmIGRlZmVycmVkLmxlbmd0aCkge1xuXHRcdFx0dGhpcy5fZGVmZXJyZWQgPSBudWxsO1xuXG5cdFx0XHRsZXQgaXRlbTogUXVldWVJdGVtO1xuXHRcdFx0d2hpbGUgKGl0ZW0gPSBkZWZlcnJlZC5zaGlmdCgpKSB7XG5cdFx0XHRcdHRoaXMuX3NjaGVkdWxlKGl0ZW0pO1xuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdHByb3RlY3RlZCBfc2NoZWR1bGUoaXRlbTogUXVldWVJdGVtKTogdm9pZCB7XG5cdFx0aWYgKCF0aGlzLl90YXNrKSB7XG5cdFx0XHR0aGlzLl90YXNrID0gdGhpcy5xdWV1ZUZ1bmN0aW9uKHRoaXMuX2JvdW5kRGlzcGF0Y2gpO1xuXHRcdH1cblxuXHRcdHRoaXMuX3F1ZXVlLnB1c2goaXRlbSk7XG5cdH1cblxuXHRjb25zdHJ1Y3Rvcihrd0FyZ3M/OiBLd0FyZ3MpIHtcblx0XHR0aGlzLmRlZmVyV2hpbGVQcm9jZXNzaW5nID0gKGt3QXJncyAmJiAnZGVmZXJXaGlsZVByb2Nlc3NpbmcnIGluIGt3QXJncykgPyBrd0FyZ3MuZGVmZXJXaGlsZVByb2Nlc3NpbmcgOiB0cnVlO1xuXHRcdHRoaXMucXVldWVGdW5jdGlvbiA9IChrd0FyZ3MgJiYga3dBcmdzLnF1ZXVlRnVuY3Rpb24pID8ga3dBcmdzLnF1ZXVlRnVuY3Rpb24gOiBxdWV1ZVRhc2s7XG5cblx0XHR0aGlzLl9ib3VuZERpc3BhdGNoID0gdGhpcy5fZGlzcGF0Y2guYmluZCh0aGlzKTtcblx0XHR0aGlzLl9pc1Byb2Nlc3NpbmcgPSBmYWxzZTtcblx0XHR0aGlzLl9xdWV1ZSA9IFtdO1xuXHR9XG5cblx0c2NoZWR1bGUoY2FsbGJhY2s6ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCk6IEhhbmRsZSB7XG5cdFx0aWYgKHRoaXMuX2lzUHJvY2Vzc2luZyAmJiB0aGlzLmRlZmVyV2hpbGVQcm9jZXNzaW5nKSB7XG5cdFx0XHRyZXR1cm4gdGhpcy5fZGVmZXIoY2FsbGJhY2spO1xuXHRcdH1cblxuXHRcdGNvbnN0IGl0ZW06IFF1ZXVlSXRlbSA9IHtcblx0XHRcdGlzQWN0aXZlOiB0cnVlLFxuXHRcdFx0Y2FsbGJhY2s6IGNhbGxiYWNrXG5cdFx0fTtcblxuXHRcdHRoaXMuX3NjaGVkdWxlKGl0ZW0pO1xuXG5cdFx0cmV0dXJuIGdldFF1ZXVlSGFuZGxlKGl0ZW0pO1xuXHR9XG59XG4iXX0=